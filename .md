# Arquitetura de Dados Corporativa

```mermaid
graph TB
    %% === CAMADA DE FONTES DE DADOS ===
    subgraph SOURCES["🔗 FONTES DE DADOS"]
        API_BC[🏦 API Banco Central]
        API_WEATHER[🌤️ API OpenWeatherMap]
        DATASETS[📊 Datasets Públicos Olist]
        STREAM[⚡ Stream de Vendas Simulada]
    end

    %% === CAMADA DE ORQUESTRAÇÃO ===
    subgraph ORCHESTRATION["🎯 ORQUESTRAÇÃO - APACHE AIRFLOW"]
        direction TB
        AIRFLOW_WEB[🌐 Airflow Webserver]
        AIRFLOW_SCHED[⚙️ Scheduler & Workers]
        AIRFLOW_META[🗄️ Metadata DB PostgreSQL]
        
        subgraph DAGS["📋 PIPELINE DAGs"]
            DAG_01[d_01_coleta_segura]
            DAG_02[d_02_validacao_basica] 
            DAG_03[d_03_mascaramento_dados]
            DAG_04[d_04_spark_processamento]
            DAG_05[d_05_validacao_GE]
            DAG_06[d_06_upload_bronze]
            DAG_07[d_07_upload_silver]
            DAG_08[d_08_lifecycle_manager]
            DAG_09[d_09_datalake_para_pg]
            DAG_10[d_10_star_schema_loader]
        end
        
        subgraph SECURITY["🔒 CAMADA DE SEGURANÇA"]
            VAULT[🔐 Vault Auth Manager]
            AUDIT[📝 Audit Logger]
            PII_PROTECT[🛡️ Proteção PII]
            CONN_POOL[🔌 Secure Connection Pool]
            EXCEPTIONS[⚠️ Exceções Customizadas]
        end
    end

    %% === DATA LAKE ===
    subgraph DATALAKE["🏞️ DATA LAKE - MinIO"]
        MINIO_SERVER[🖥️ MinIO Server]
        BRONZE[🥉 Bronze Layer Raw Data]
        SILVER[🥈 Silver Layer Curated]
        ANALYTICS[💎 Analytics Layer]
        COLD_STORAGE[❄️ Cold Storage Archive]
    end

    %% === PROCESSAMENTO ===
    subgraph PROCESSING["⚡ PROCESSAMENTO DISTRIBUÍDO"]
        SPARK_CLUSTER[🔥 Apache Spark Cluster]
    end

    %% === DATA WAREHOUSE ===
    subgraph DW["🏛️ DATA WAREHOUSE - PostgreSQL"]
        PG_SERVER[🗄️ PostgreSQL Server]
        DIM_CLIENTE[👥 dim_cliente]
        DIM_PRODUTO[📦 dim_produto] 
        FATO_VENDAS[💰 fato_vendas]
        DADOS_OLIST[🛒 dados_olist]
    end

    %% === GOVERNANÇA ===
    subgraph GOVERNANCE["📊 GOVERNANÇA & QUALIDADE"]
        GREAT_EXP[✅ Great Expectations]
        AUDIT_LOGS[📋 Logs de Auditoria]
        LINEAGE[🔍 Data Lineage]
    end

    %% === FLUXO PRINCIPAL DE DADOS ===
    API_BC --> DAG_01
    API_WEATHER --> DAG_01
    DATASETS --> DAG_03
    STREAM --> DAG_04
    STREAM --> DAG_09

    %% Orquestração interna
    AIRFLOW_WEB --> AIRFLOW_SCHED
    AIRFLOW_SCHED --> AIRFLOW_META
    AIRFLOW_SCHED --> DAGS

    %% Pipeline de transformação
    DAG_01 --> DAG_02
    DAG_02 --> DAG_03
    DAG_03 --> DAG_04
    DAG_04 --> DAG_05
    DAG_05 --> DAG_06
    DAG_06 --> DAG_07
    DAG_07 --> DAG_08

    %% Carregamento no Data Lake
    DAG_01 --> BRONZE
    DAG_06 --> BRONZE
    DAG_03 --> SILVER
    DAG_07 --> SILVER
    DAG_04 --> ANALYTICS
    
    %% Progressão entre camadas
    BRONZE --> SILVER
    SILVER --> ANALYTICS
    DAG_08 --> COLD_STORAGE
    BRONZE --> COLD_STORAGE

    %% Integração com Spark
    DAG_04 --> SPARK_CLUSTER
    SPARK_CLUSTER --> ANALYTICS

    %% Pipeline para DW
    SILVER --> DAG_09
    ANALYTICS --> DAG_09
    DAG_09 --> DADOS_OLIST
    DADOS_OLIST --> DAG_10
    DAG_10 --> DIM_CLIENTE
    DAG_10 --> DIM_PRODUTO
    DAG_10 --> FATO_VENDAS

    %% Segurança e Governança
    VAULT --> MINIO_SERVER
    VAULT --> PG_SERVER
    CONN_POOL --> VAULT
    PII_PROTECT --> AUDIT
    DAG_03 --> PII_PROTECT
    DAG_05 --> GREAT_EXP
    GREAT_EXP --> AUDIT_LOGS
    AUDIT --> AUDIT_LOGS
    EXCEPTIONS --> AUDIT

    %% Estilo visual
    classDef sourceStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef orchestrationStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef storageStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef processingStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef governanceStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class SOURCES,API_BC,API_WEATHER,DATASETS,STREAM sourceStyle
    class ORCHESTRATION,DAGS,SECURITY orchestrationStyle
    class DATALAKE,DW storageStyle
    class PROCESSING,SPARK_CLUSTER processingStyle
    class GOVERNANCE governanceStyle
