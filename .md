# Arquitetura de Dados Corporativa

```mermaid
graph TB
    %% === CAMADA DE FONTES DE DADOS ===
    subgraph SOURCES["ðŸ”— FONTES DE DADOS"]
        API_BC[ðŸ¦ API Banco Central]
        API_WEATHER[ðŸŒ¤ï¸ API OpenWeatherMap]
        DATASETS[ðŸ“Š Datasets PÃºblicos Olist]
        STREAM[âš¡ Stream de Vendas Simulada]
    end

    %% === CAMADA DE ORQUESTRAÃ‡ÃƒO ===
    subgraph ORCHESTRATION["ðŸŽ¯ ORQUESTRAÃ‡ÃƒO - APACHE AIRFLOW"]
        direction TB
        AIRFLOW_WEB[ðŸŒ Airflow Webserver]
        AIRFLOW_SCHED[âš™ï¸ Scheduler & Workers]
        AIRFLOW_META[ðŸ—„ï¸ Metadata DB PostgreSQL]
        
        subgraph DAGS["ðŸ“‹ PIPELINE DAGs"]
            DAG_01[d_01_coleta_segura]
            DAG_02[d_02_validacao_basica] 
            DAG_03[d_03_mascaramento_dados]
            DAG_04[d_04_spark_processamento]
            DAG_05[d_05_validacao_GE]
            DAG_06[d_06_upload_bronze]
            DAG_07[d_07_upload_silver]
            DAG_08[d_08_lifecycle_manager]
            DAG_09[d_09_datalake_para_pg]
            DAG_10[d_10_star_schema_loader]
        end
        
        subgraph SECURITY["ðŸ”’ CAMADA DE SEGURANÃ‡A"]
            VAULT[ðŸ” Vault Auth Manager]
            AUDIT[ðŸ“ Audit Logger]
            PII_PROTECT[ðŸ›¡ï¸ ProteÃ§Ã£o PII]
            CONN_POOL[ðŸ”Œ Secure Connection Pool]
            EXCEPTIONS[âš ï¸ ExceÃ§Ãµes Customizadas]
        end
    end

    %% === DATA LAKE ===
    subgraph DATALAKE["ðŸžï¸ DATA LAKE - MinIO"]
        MINIO_SERVER[ðŸ–¥ï¸ MinIO Server]
        BRONZE[ðŸ¥‰ Bronze Layer Raw Data]
        SILVER[ðŸ¥ˆ Silver Layer Curated]
        ANALYTICS[ðŸ’Ž Analytics Layer]
        COLD_STORAGE[â„ï¸ Cold Storage Archive]
    end

    %% === PROCESSAMENTO ===
    subgraph PROCESSING["âš¡ PROCESSAMENTO DISTRIBUÃDO"]
        SPARK_CLUSTER[ðŸ”¥ Apache Spark Cluster]
    end

    %% === DATA WAREHOUSE ===
    subgraph DW["ðŸ›ï¸ DATA WAREHOUSE - PostgreSQL"]
        PG_SERVER[ðŸ—„ï¸ PostgreSQL Server]
        DIM_CLIENTE[ðŸ‘¥ dim_cliente]
        DIM_PRODUTO[ðŸ“¦ dim_produto] 
        FATO_VENDAS[ðŸ’° fato_vendas]
        DADOS_OLIST[ðŸ›’ dados_olist]
    end

    %% === GOVERNANÃ‡A ===
    subgraph GOVERNANCE["ðŸ“Š GOVERNANÃ‡A & QUALIDADE"]
        GREAT_EXP[âœ… Great Expectations]
        AUDIT_LOGS[ðŸ“‹ Logs de Auditoria]
        LINEAGE[ðŸ” Data Lineage]
    end

    %% === FLUXO PRINCIPAL DE DADOS ===
    API_BC --> DAG_01
    API_WEATHER --> DAG_01
    DATASETS --> DAG_03
    STREAM --> DAG_04
    STREAM --> DAG_09

    %% OrquestraÃ§Ã£o interna
    AIRFLOW_WEB --> AIRFLOW_SCHED
    AIRFLOW_SCHED --> AIRFLOW_META
    AIRFLOW_SCHED --> DAGS

    %% Pipeline de transformaÃ§Ã£o
    DAG_01 --> DAG_02
    DAG_02 --> DAG_03
    DAG_03 --> DAG_04
    DAG_04 --> DAG_05
    DAG_05 --> DAG_06
    DAG_06 --> DAG_07
    DAG_07 --> DAG_08

    %% Carregamento no Data Lake
    DAG_01 --> BRONZE
    DAG_06 --> BRONZE
    DAG_03 --> SILVER
    DAG_07 --> SILVER
    DAG_04 --> ANALYTICS
    
    %% ProgressÃ£o entre camadas
    BRONZE --> SILVER
    SILVER --> ANALYTICS
    DAG_08 --> COLD_STORAGE
    BRONZE --> COLD_STORAGE

    %% IntegraÃ§Ã£o com Spark
    DAG_04 --> SPARK_CLUSTER
    SPARK_CLUSTER --> ANALYTICS

    %% Pipeline para DW
    SILVER --> DAG_09
    ANALYTICS --> DAG_09
    DAG_09 --> DADOS_OLIST
    DADOS_OLIST --> DAG_10
    DAG_10 --> DIM_CLIENTE
    DAG_10 --> DIM_PRODUTO
    DAG_10 --> FATO_VENDAS

    %% SeguranÃ§a e GovernanÃ§a
    VAULT --> MINIO_SERVER
    VAULT --> PG_SERVER
    CONN_POOL --> VAULT
    PII_PROTECT --> AUDIT
    DAG_03 --> PII_PROTECT
    DAG_05 --> GREAT_EXP
    GREAT_EXP --> AUDIT_LOGS
    AUDIT --> AUDIT_LOGS
    EXCEPTIONS --> AUDIT

    %% Estilo visual
    classDef sourceStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef orchestrationStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef storageStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef processingStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef governanceStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class SOURCES,API_BC,API_WEATHER,DATASETS,STREAM sourceStyle
    class ORCHESTRATION,DAGS,SECURITY orchestrationStyle
    class DATALAKE,DW storageStyle
    class PROCESSING,SPARK_CLUSTER processingStyle
    class GOVERNANCE governanceStyle
