# Arquitetura de Dados 

```mermaid
graph TD
    subgraph "1. Fontes de Dados"
        BC[Banco Central API 📈]
        WEATHER[OpenWeather API ☁️]
        OLIST[Olist Dataset 📦]
        STREAM[Sales Stream ⚡]
    end

    subgraph "2. Custom Security Layer"
        SEC_MGR[AirflowSecurityManager - Vault Customizado]
        AUDIT[AuditLogger - Trilha de Auditoria]
        DATA_PROTECT[DataProtection - Mascaramento PII]
        CONN_POOL[SecureConnectionPool - Conexões Seguras]
    end

    subgraph "3. Airflow DAGs Pipeline"
        DAG_COLLECT[dag_01_coleta_segura - Coleta IPCA & Clima]
        DAG_CONSOLIDA[dag_consolida_olist - Consolida Dataset Olist]
        DAG_VALIDATE_BASIC[dag_coleta_e_validacao - Validação Básica]
        DAG_MASK[dag_03_mascaramento_dados - Mascaramento PII]
        DAG_SPARK[dag_04_spark_processamento - Processa Vendas c/ PySpark]
        DAG_VALIDATE_GE[dag_05_validacao_segura - Validação Great Expectations]
        DAG_UPLOAD_BRONZE[dag_upload_bronze - Upload Camada Bronze]
        DAG_UPLOAD_SILVER[dag_upload_silver - Upload Camada Silver]
        DAG_LIFECYCLE[dag_gerenciamento_lifecycle - Gestão Ciclo de Vida]
        DAG_MINIO_PG[dag_minio_para_postgresql - MinIO para PostgreSQL]
        DAG_CARGA_STAR[dag_06_carrega_star_schema - Carga Dimensional]
    end

    subgraph "4. Storage Architecture (MinIO)"
        BRONZE[(Bronze Layer)]
        SILVER[(Silver Layer)]
        ANALYTICS[(Analytics Layer)]
        COLD[(Cold Storage)]
    end

    subgraph "5. Data Warehouse (PostgreSQL)"
        PG_DW[(PostgreSQL DW)]
        STAR_SCHEMA[Star Schema Dimensional]
        TB_OLIST[Tabela dados_olist]
    end

    subgraph "6. Quality & Governance"
        GE[Great Expectations Suite ✅]
        Logs[Arquivos de Log 📋]
    end

    %% Main Data Flow - Corrigido
    BC --> DAG_COLLECT
    WEATHER --> DAG_COLLECT
    STREAM --> DAG_COLLECT
    OLIST --> DAG_CONSOLIDA

    DAG_COLLECT --> DAG_VALIDATE_BASIC
    DAG_VALIDATE_BASIC --> DAG_UPLOAD_BRONZE
    DAG_UPLOAD_BRONZE --> BRONZE

    DAG_CONSOLIDA --> DAG_MASK
    DAG_MASK --> DAG_VALIDATE_GE
    DAG_MASK --> DAG_UPLOAD_SILVER
    DAG_UPLOAD_SILVER --> SILVER

    DAG_VALIDATE_GE -->|Certifica Dados para| DAG_SPARK
    DAG_SPARK --> ANALYTICS

    %% Storage Lifecycle
    BRONZE -->|Ciclo de Vida| COLD
    DAG_LIFECYCLE --> BRONZE
    DAG_LIFECYCLE --> COLD

    %% DW Pipeline
    ANALYTICS --> DAG_MINIO_PG
    DAG_MINIO_PG --> TB_OLIST
    TB_OLIST --> DAG_CARGA_STAR
    DAG_CARGA_STAR --> STAR_SCHEMA

    %% Custom Security Integration - Fluxo de Credenciais
    SEC_MGR -->|Credenciais API| DAG_COLLECT
    SEC_MGR -->|Chaves Mascaramento| DATA_PROTECT
    SEC_MGR -->|Credenciais MinIO| DAG_UPLOAD_BRONZE
    SEC_MGR -->|Credenciais MinIO| DAG_UPLOAD_SILVER
    SEC_MGR -->|Credenciais MinIO| DAG_LIFECYCLE
    SEC_MGR -->|Credenciais MinIO| DAG_SPARK
    SEC_MGR -->|Credenciais PostgreSQL| DAG_MINIO_PG
    SEC_MGR -->|Credenciais PostgreSQL| DAG_CARGA_STAR

    DATA_PROTECT --> DAG_MASK
    CONN_POOL --> SEC_MGR
    CONN_POOL -->|Conexões Seguras| DAG_UPLOAD_BRONZE
    CONN_POOL -->|Conexões Seguras| DAG_UPLOAD_SILVER
    CONN_POOL -->|Conexões Seguras| DAG_MINIO_PG
    CONN_POOL -->|Conexões Seguras| DAG_CARGA_STAR

    %% Audit Trail - Completo
    DAG_COLLECT --> AUDIT
    DAG_CONSOLIDA --> AUDIT
    DAG_VALIDATE_BASIC --> AUDIT
    DAG_MASK --> AUDIT
    DAG_SPARK --> AUDIT
    DAG_VALIDATE_GE --> AUDIT
    SEC_MGR --> AUDIT
    AUDIT --> Logs

    %% Quality Validation - Corrigido
    GE --> DAG_VALIDATE_GE
    GE -->|Valida Dados em| SILVER
    DAG_VALIDATE_GE -->|Gate de Qualidade| ANALYTICS

    %% Styling
    classDef source fill:#1565C0,stroke:#0D47A1,stroke-width:2px,color:#fff
    classDef security fill:#7B1FA2,stroke:#4A148C,stroke-width:2px,color:#fff
    classDef pipeline fill:#2E7D32,stroke:#1B5E20,stroke-width:2px,color:#fff
    classDef storage fill:#E65100,stroke:#BF360C,stroke-width:2px,color:#fff
    classDef quality fill:#D32F2F,stroke:#B71C1C,stroke-width:2px,color:#fff
    classDef audit_log fill:#E91E63,stroke:#C2185B,stroke-width:2px,color:#fff

    class BC,WEATHER,OLIST,STREAM source
    class SEC_MGR,DATA_PROTECT,CONN_POOL security
    class DAG_COLLECT,DAG_CONSOLIDA,DAG_VALIDATE_BASIC,DAG_MASK,DAG_SPARK,DAG_VALIDATE_GE,DAG_UPLOAD_BRONZE,DAG_UPLOAD_SILVER,DAG_LIFECYCLE,DAG_MINIO_PG,DAG_CARGA_STAR pipeline
    class BRONZE,SILVER,ANALYTICS,COLD,PG_DW,STAR_SCHEMA,TB_OLIST storage
    class GE quality
    class AUDIT,Logs audit_log
