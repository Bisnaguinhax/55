```mermaid
graph TD
    subgraph "1. Fontes de Dados"
        API_BC["API Banco Central (IPCA)"]
        API_OWM["API OpenWeatherMap"]
        DS_OLIST["Datasets Públicos Olist"]
        SIM_STREAM["Simulador de Stream de Vendas"]
    end

    subgraph "2. Ingestão e Orquestração - Apache Airflow"
        AF_WEBSERVER["Airflow Webserver"]
        AF_SCHEDULER["Airflow Scheduler & Workers"]
        AF_DB["Airflow Metadata DB (PostgreSQL)"]

        subgraph "DAGs do Airflow"
            DAG_COLETA_SEGURA["dag_01_coleta_segura_v1.py - Coleta IPCA/Clima"]
            DAG_COLETA_VALIDA["dag_coleta_e_validacao_v1.py - Coleta & Validação"]
            DAG_CONSOLIDA_MASK["dag_03_consolidacao_e_mascaramento_v1.py - Mascaramento"]
            DAG_SPARK_SEGURO["dag_04_processamento_spark_seguro_v1.py - Spark Seguro"]
            DAG_VALIDA_GE["dag_05_validacao_segura_v1.py - Great Expectations"]
            DAG_UPLOAD_BRONZE["dag_upload_bronze_minio_v1.py - Bronze"]
            DAG_UPLOAD_SILVER["dag_upload_silver_minio_v1.py - Silver"]
            DAG_LIFECYCLE["dag_gerenciamento_lifecycle_v1.py - Lifecycle"]
            DAG_MINIO_PG["dag_minio_para_postgresql_v1.py - Data Lake > Mart"]
            DAG_CARGA_STAR["dag_06_carrega_star_schema_segura_v1.py - Star Schema"]
        end

        subgraph "Segurança (Plugin Airflow)"
            SEC_MANAGER["AirflowSecurityManager - Vault"]
            AUDIT_LOGGER["AuditLogger - Logs"]
            DATA_PROTECTION["DataProtection - Mascaramento"]
            CONN_POOL["SecureConnectionPool"]
            EXCEPTIONS["Exceções Customizadas"]
        end
    end

    subgraph "3. Data Lake (MinIO)"
        MINIO_SERVER["MinIO Server"]
        BRONZE_LAYER["Camada Bronze - Dados Brutos"]
        SILVER_LAYER["Camada Silver - Dados Curados"]
        ANALYTICS_LAYER["Camada Analytics - Processados"]
        COLD_STORAGE["Cold Storage - Arquivos Antigos"]
    end

    subgraph "4. Processamento - Spark"
        SPARK_CLUSTER["Apache Spark Cluster"]
    end

    subgraph "5. Data Mart - PostgreSQL"
        PG_SERVER["PostgreSQL Data Mart"]
        DM_CLIENTE["dim_cliente"]
        DM_PRODUTO["dim_produto"]
        FT_VENDAS["fato_vendas"]
        TB_OLIST["dados_olist"]
    end

    subgraph "6. Qualidade & Governança"
        GE_VALIDATION["Great Expectations"]
        AUDIT_LOGS_FILES["Arquivos de Log: audit.csv / system.log"]
    end

    %% Fluxos principais
    API_BC --> DAG_COLETA_SEGURA
    API_OWM --> DAG_COLETA_SEGURA
    DS_OLIST --> DAG_CONSOLIDA_MASK
    SIM_STREAM --> DAG_SPARK_SEGURO
    SIM_STREAM --> DAG_MINIO_PG

    AF_WEBSERVER --> AF_SCHEDULER
    AF_SCHEDULER --> AF_DB
    AF_SCHEDULER --> DAG_COLETA_SEGURA
    AF_SCHEDULER --> DAG_COLETA_VALIDA
    AF_SCHEDULER --> DAG_CONSOLIDA_MASK
    AF_SCHEDULER --> DAG_SPARK_SEGURO
    AF_SCHEDULER --> DAG_VALIDA_GE
    AF_SCHEDULER --> DAG_UPLOAD_BRONZE
    AF_SCHEDULER --> DAG_UPLOAD_SILVER
    AF_SCHEDULER --> DAG_LIFECYCLE
    AF_SCHEDULER --> DAG_MINIO_PG
    AF_SCHEDULER --> DAG_CARGA_STAR

    %% Data Lake
    DAG_COLETA_SEGURA --> BRONZE_LAYER
    DAG_COLETA_VALIDA --> BRONZE_LAYER
    DAG_UPLOAD_BRONZE --> BRONZE_LAYER
    DAG_CONSOLIDA_MASK --> SILVER_LAYER
    DAG_UPLOAD_SILVER --> SILVER_LAYER
    SPARK_CLUSTER --> ANALYTICS_LAYER
    BRONZE_LAYER --> SILVER_LAYER
    SILVER_LAYER --> ANALYTICS_LAYER
    BRONZE_LAYER --> COLD_STORAGE
    DAG_LIFECYCLE --> BRONZE_LAYER
    DAG_LIFECYCLE --> COLD_STORAGE

    %% PostgreSQL
    ANALYTICS_LAYER --> DAG_MINIO_PG
    SILVER_LAYER --> DAG_MINIO_PG
    DAG_MINIO_PG --> TB_OLIST
    TB_OLIST --> DAG_CARGA_STAR
    DAG_CARGA_STAR --> PG_SERVER

    %% Segurança e Governança
    DAG_COLETA_SEGURA --> SEC_MANAGER
    DAG_CONSOLIDA_MASK --> SEC_MANAGER
    DAG_SPARK_SEGURO --> SEC_MANAGER
    DAG_MINIO_PG --> SEC_MANAGER
    DAG_CARGA_STAR --> SEC_MANAGER
    DAG_LIFECYCLE --> SEC_MANAGER
    DAG_UPLOAD_BRONZE --> SEC_MANAGER
    DAG_UPLOAD_SILVER --> SEC_MANAGER

    SEC_MANAGER --> MINIO_SERVER
    SEC_MANAGER --> PG_SERVER
    SEC_MANAGER --> AUDIT_LOGGER

    DAG_COLETA_SEGURA --> AUDIT_LOGGER
    DAG_CONSOLIDA_MASK --> AUDIT_LOGGER
    DAG_VALIDA_GE --> AUDIT_LOGGER
    DAG_MINIO_PG --> AUDIT_LOGGER
    DAG_CARGA_STAR --> AUDIT_LOGGER
    DAG_LIFECYCLE --> AUDIT_LOGGER
    DAG_UPLOAD_BRONZE --> AUDIT_LOGGER
    DAG_UPLOAD_SILVER --> AUDIT_LOGGER

    DAG_CONSOLIDA_MASK --> DATA_PROTECTION
    DATA_PROTECTION --> AUDIT_LOGGER

    DAG_VALIDA_GE --> GE_VALIDATION
    GE_VALIDATION --> AUDIT_LOGGER
    DAG_VALIDA_GE --> EXCEPTIONS

    CONN_POOL --> SEC_MANAGER
    CONN_POOL --> PG_SERVER
    CONN_POOL --> MINIO_SERVER
```
